<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChatSpheres - Explore Forums</title>
  <meta name="description" content="Discover video chat communities on ChatSpheres.">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>window.__CHATSPHERES_CONFIG__ = window.__CHATSPHERES_CONFIG__ || {};</script>
  <script src="/.netlify/functions/client-config"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/brand.css?v=2">
  <link rel="stylesheet" href="/assets/css/ads.css?v=2">
  
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='24' cy='32' r='18' stroke='%23e63946' stroke-width='4' fill='none'/%3E%3Ccircle cx='40' cy='32' r='18' stroke='%23e63946' stroke-width='4' fill='none'/%3E%3C/svg%3E">
  
  <style>
    .main-content { padding-top: 80px; max-width: 1200px; margin: 0 auto; padding-left: var(--space-lg); padding-right: var(--space-lg); }
    
    .forums-hero { text-align: center; padding: var(--space-lg) 0; }
    .forums-title { font-size: 2.5rem; font-weight: var(--font-weight-extrabold); color: var(--charcoal); margin-bottom: var(--space-xs); }
    .forums-subtitle { color: var(--charcoal); opacity: 0.7; font-size: 1.1rem; }
    
    .create-cta { background: white; border-radius: var(--radius-xl); padding: var(--space-xl); border: 4px solid var(--gold); margin-bottom: var(--space-xl); display: flex; align-items: center; justify-content: space-between; gap: var(--space-lg); flex-wrap: wrap; }
    .create-cta-text h3 { color: var(--charcoal); margin-bottom: var(--space-xs); font-size: 1.3rem; }
    .create-cta-text p { color: var(--charcoal); opacity: 0.7; margin: 0; }
    .create-btn { display: inline-flex; align-items: center; gap: var(--space-sm); padding: var(--space-md) var(--space-xl); background: var(--main-red); color: white; border: none; border-radius: var(--radius-lg); font-family: var(--font-family); font-weight: var(--font-weight-bold); font-size: 1.1rem; cursor: pointer; text-decoration: none; transition: all var(--transition-fast); white-space: nowrap; }
    .create-btn:hover { background: var(--charcoal); transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    
    .controls-row { display: flex; gap: var(--space-md); margin-bottom: var(--space-lg); flex-wrap: wrap; align-items: center; }
    .search-bar { display: flex; gap: var(--space-xs); flex: 1; min-width: 250px; max-width: 400px; }
    .search-input { flex: 1; padding: var(--space-sm) var(--space-md); border: 3px solid var(--rose); border-radius: var(--radius-lg); font-family: var(--font-family); font-size: 1rem; outline: none; }
    .search-input:focus { border-color: var(--main-red); }
    .search-btn { padding: var(--space-sm) var(--space-lg); background: var(--main-red); color: white; border: none; border-radius: var(--radius-lg); font-family: var(--font-family); font-weight: var(--font-weight-bold); cursor: pointer; }
    .search-btn:hover { background: var(--charcoal); }
    
    .filter-tabs { display: flex; gap: var(--space-xs); flex-wrap: wrap; }
    .filter-tab { padding: var(--space-sm) var(--space-md); border-radius: var(--radius-full); font-weight: var(--font-weight-bold); font-family: var(--font-family); border: 3px solid transparent; cursor: pointer; transition: all var(--transition-fast); background: white; color: var(--charcoal); }
    .filter-tab:hover { background: var(--light-rose); }
    .filter-tab.active { background: var(--main-red); color: white; border-color: var(--main-red); }
    
    .category-row { display: flex; gap: var(--space-xs); flex-wrap: wrap; margin-bottom: var(--space-xl); justify-content: center; }
    .category-btn { padding: var(--space-xs) var(--space-md); border-radius: var(--radius-lg); font-size: 0.9rem; background: white; border: 2px solid var(--rose); color: var(--charcoal); cursor: pointer; transition: all var(--transition-fast); text-decoration: none; font-weight: var(--font-weight-semibold); }
    .category-btn:hover, .category-btn.active { border-color: var(--main-red); background: var(--light-rose); color: var(--main-red); }
    
    .forums-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: var(--space-lg); }
    
    .forum-card { background: white; border-radius: var(--radius-xl); overflow: hidden; box-shadow: var(--shadow-md); transition: all var(--transition-fast); border: 3px solid var(--rose); text-decoration: none; display: block; }
    .forum-card:hover { transform: translateY(-6px); box-shadow: var(--shadow-xl); border-color: var(--main-red); }
    .forum-card-banner { height: 100px; background: linear-gradient(135deg, var(--main-red) 0%, var(--gold) 100%); position: relative; }
    .forum-card-banner img { width: 100%; height: 100%; object-fit: cover; }
    .forum-card-icon { width: 64px; height: 64px; border-radius: var(--radius-xl); background: white; border: 4px solid white; position: absolute; bottom: -32px; left: var(--space-lg); display: flex; align-items: center; justify-content: center; font-size: 2rem; box-shadow: var(--shadow-md); overflow: hidden; }
    .forum-card-icon img { width: 100%; height: 100%; object-fit: cover; }
    .forum-card-body { padding: var(--space-lg); padding-top: calc(var(--space-lg) + 24px); }
    .forum-card-name { font-weight: var(--font-weight-bold); color: var(--charcoal); font-size: 1.2rem; margin-bottom: var(--space-xs); display: flex; align-items: center; gap: var(--space-xs); flex-wrap: wrap; }
    .nsfw-badge { font-size: 0.65rem; background: #ef4444; color: white; padding: 3px 8px; border-radius: var(--radius-sm); font-weight: var(--font-weight-bold); }
    .forum-card-slug { color: var(--charcoal); opacity: 0.5; font-size: 0.9rem; margin-bottom: var(--space-sm); }
    .forum-card-desc { color: var(--charcoal); opacity: 0.7; font-size: 0.95rem; line-height: 1.5; margin-bottom: var(--space-md); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; min-height: 2.8em; }
    .forum-card-stats { display: flex; gap: var(--space-lg); font-size: 0.9rem; color: var(--charcoal); }
    .forum-card-stat { display: flex; align-items: center; gap: var(--space-xs); }
    .forum-card-stat.live { color: #10b981; font-weight: var(--font-weight-bold); }
    
    .empty-state { text-align: center; padding: var(--space-2xl); background: white; border-radius: var(--radius-xl); border: 3px solid var(--rose); }
    .empty-state-icon { font-size: 5rem; margin-bottom: var(--space-md); }
    .empty-state h2 { color: var(--charcoal); margin-bottom: var(--space-sm); }
    .empty-state p { color: var(--charcoal); opacity: 0.7; margin-bottom: var(--space-lg); }
    
    .loading-spinner { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--space-2xl); gap: var(--space-md); }
    .spinner { width: 48px; height: 48px; border: 5px solid var(--light-rose); border-top-color: var(--main-red); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    footer { text-align: center; padding: var(--space-xl); color: var(--charcoal); font-size: 0.875rem; border-top: 2px solid var(--rose); margin-top: var(--space-2xl); }
    footer a { color: var(--main-red); }
    
    /* Responsive styles */
    @media (max-width: 768px) {
      .forums-hero { padding: var(--space-xl) var(--space-md); }
      .forums-title { font-size: 1.75rem; }
      .forums-subtitle { font-size: 1rem; }
      .create-cta { flex-direction: column; text-align: center; padding: var(--space-lg); }
      .create-btn { width: 100%; justify-content: center; }
      .controls-row { flex-direction: column; gap: var(--space-sm); }
      .search-bar { max-width: 100%; min-width: unset; }
      .filter-tabs { width: 100%; justify-content: center; }
      .category-row { justify-content: flex-start; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: var(--space-sm); flex-wrap: nowrap; }
      .category-btn { flex-shrink: 0; }
      .forums-grid { grid-template-columns: 1fr; }
      .forum-card-body { padding: var(--space-md); padding-top: calc(var(--space-md) + 24px); }
      .forum-card-stats { flex-wrap: wrap; gap: var(--space-sm); }
    }
    
    @media (max-width: 480px) {
      .forums-title { font-size: 1.5rem; }
      .filter-tabs { gap: 4px; }
      .filter-tab { padding: var(--space-xs) var(--space-sm); font-size: 0.85rem; }
      .forum-card-icon { width: 48px; height: 48px; bottom: -24px; }
      .forum-card-body { padding-top: calc(var(--space-md) + 16px); }
    }
  </style>
</head>
<body>
  <div class="bg-pattern"></div>
  
  <header class="site-header" style="position: relative; z-index: 500000;">
    <div class="header-container">
      <!-- Left side: Menu button -->
      <div class="header-left" style="display: flex; align-items: center; gap: var(--space-sm); z-index: 999999;">
        <button id="menu-toggle" class="menu-toggle" aria-label="Toggle menu" style="z-index: 999999; position: relative; pointer-events: auto;">
          <span class="menu-bar"></span><span class="menu-bar"></span><span class="menu-bar"></span>
        </button>
        <a href="/explore.html" class="site-logo">
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="24" cy="32" r="20" stroke="#FCE2E5" stroke-width="6"/>
            <circle cx="40" cy="32" r="20" stroke="#FCE2E5" stroke-width="6"/>
            <circle cx="24" cy="32" r="18" stroke="#e63946" stroke-width="4" fill="none"/>
            <circle cx="40" cy="32" r="18" stroke="#e63946" stroke-width="4" fill="none"/>
          </svg>
          <span class="site-logo-text">ChatSpheres</span>
        </a>
      </div>
      <!-- Right side: Gem badge -->
      <div class="header-actions">
        <div id="header-gem-badge" class="header-gem-badge" style="display: none;" onclick="window.location.href='/cashout.html'">
          <span>ğŸ’</span><span class="gem-count">0</span>
        </div>
      </div>
    </div>
  </header>
  
  <div id="nav-overlay" class="nav-overlay"></div>
  
  <nav id="nav-menu" class="nav-menu">
    <button id="nav-close" class="nav-close">Ã—</button>
    <ul class="nav-links">
      <li><a href="/explore.html" class="nav-link"><span class="nav-link-icon">ğŸ </span> Home</a></li>
      <li><a href="/live.html" class="nav-link"><span class="nav-link-icon">ğŸ”´</span> Live Rooms</a></li>
      <li><a href="/matchmaking.html" class="nav-link"><span class="nav-link-icon">ğŸ¯</span> Find Match</a></li>
      <li><a href="/forums" class="nav-link active"><span class="nav-link-icon">ğŸŒ</span> Forums</a></li>
      <li><a href="/recordings.html" class="nav-link"><span class="nav-link-icon">ğŸ“¹</span> Recordings</a></li>
      <li><a href="/pricing.html" class="nav-link"><span class="nav-link-icon">ğŸ’</span> Pricing</a></li>
    </ul>
    <div class="nav-divider"></div>
    <ul class="nav-links">
      <li><a href="/about.html" class="nav-link"><span class="nav-link-icon">â„¹ï¸</span> About</a></li>
      <li><a href="#" class="nav-link" onclick="openFeedbackModal(); return false;"><span class="nav-link-icon">ğŸ’¬</span> Feedback</a></li>
      <li><a href="/profile.html" class="nav-link"><span class="nav-link-icon">ğŸ‘¤</span> Profile</a></li>
      <li><a href="/cashout.html" class="nav-link"><span class="nav-link-icon">ğŸ’°</span> Cash Out</a></li>
      <li><a href="/affiliate.html" class="nav-link"><span class="nav-link-icon">ğŸ”—</span> Affiliate</a></li>
      <li><a href="/branding.html" id="nav-branding-link" class="nav-link" style="display: none;"><span class="nav-link-icon">ğŸ¨</span> Branding</a></li>
    </ul>
    <div id="nav-guest-links" class="nav-user-section">
      <a href="/login.html" class="btn btn-primary btn-full" style="text-decoration: none;">Sign In</a>
    </div>
    <div id="nav-user-section" class="nav-user-section" style="display: none;">
      <div class="nav-user-info">
        <div class="nav-user-avatar">ğŸ‘¤</div>
        <div class="nav-user-details">
          <div id="nav-user-name" class="nav-user-name">User</div>
          <div class="nav-user-gems">ğŸ’ <span id="nav-user-gems">0</span> gems</div>
        </div>
      </div>
      <button onclick="handleLogout()" class="btn btn-ghost btn-full">Sign Out</button>
    </div>
  </nav>

  <main class="main-content">
    <section class="forums-hero">
      <h1 class="forums-title">ğŸŒ Explore Forums</h1>
      <p class="forums-subtitle">Discover communities and join live video conversations</p>
    </section>
    
    <div class="create-cta" id="createCTA" style="display: none;">
      <div class="create-cta-text">
        <h3>ğŸš€ Start Your Community</h3>
        <p>Create a forum and earn 10% of all tips from rooms in your community!</p>
      </div>
      <a href="/create-forum" class="create-btn">+ Create Forum</a>
    </div>
    
    <div class="controls-row">
      <div class="search-bar">
        <input type="text" class="search-input" id="searchInput" placeholder="Search forums...">
        <button class="search-btn" id="searchBtn">ğŸ”</button>
      </div>
      <div class="filter-tabs">
        <button class="filter-tab active" data-filter="top">ğŸ”¥ Top</button>
        <button class="filter-tab" data-filter="live">ğŸ“º Live</button>
        <button class="filter-tab" data-filter="upcoming">ğŸ“… Events</button>
        <button class="filter-tab" data-filter="new">âœ¨ New</button>
        <button class="filter-tab" data-filter="joined" id="joinedTab" style="display:none;">â­ My Forums</button>
      </div>
    </div>
    
    <div class="category-row">
      <a href="#" class="category-btn active" data-category="all">All</a>
      <a href="#" class="category-btn" data-category="gaming">ğŸ® Gaming</a>
      <a href="#" class="category-btn" data-category="technology">ğŸ’» Tech</a>
      <a href="#" class="category-btn" data-category="music">ğŸµ Music</a>
      <a href="#" class="category-btn" data-category="entertainment">ğŸ¬ Entertainment</a>
      <a href="#" class="category-btn" data-category="just_chatting">ğŸ’¬ Just Chatting</a>
    </div>
    
    <div id="forumsContainer">
      <div class="loading-spinner"><div class="spinner"></div><p>Loading forums...</p></div>
    </div>
    
    <footer>
      <p><a href="/terms.html">Terms</a> Â· <a href="/privacy.html">Privacy</a> Â· <a href="/community-guidelines.html">Guidelines</a></p>
      <p style="margin-top: var(--space-sm); opacity: 0.7;">Â© 2025 ChatSpheres</p>
    </footer>
  </main>

  <script src="/assets/js/navigation.js?v=2"></script>
  <script>
    let currentFilter = 'top', currentCategory = 'all', currentUser = null, supabaseClient = null;
    const categoryIcons = { gaming: 'ğŸ®', technology: 'ğŸ’»', music: 'ğŸµ', entertainment: 'ğŸ¬', business: 'ğŸ’¼', education: 'ğŸ“š', fitness: 'ğŸ’ª', creative: 'ğŸ¨', just_chatting: 'ğŸ’¬', other: 'ğŸ“' };

    function initSupabase() {
      const config = window.__CHATSPHERES_CONFIG__ || {};
      const supabaseConfig = config.supabase || {};
      const authConfig = config.auth || {};
      
      const SUPABASE_URL = supabaseConfig.url || config.SUPABASE_URL || '';
      const SUPABASE_ANON_KEY = supabaseConfig.anonKey || config.SUPABASE_ANON_KEY || '';
      const AUTH_COOKIE_DOMAIN = authConfig.cookieDomain || '.chatspheres.com';
      
      if (!SUPABASE_URL || !SUPABASE_ANON_KEY) return null;
      
      return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true,
          flowType: 'pkce',
          storage: {
            getItem: (key) => {
              const cookies = document.cookie.split(';');
              for (const cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === key) return decodeURIComponent(value);
              }
              try { return localStorage.getItem(key); } catch(e) { return null; }
            },
            setItem: (key, value) => {
              const maxAge = 60 * 60 * 24 * 365;
              let cookieStr = `${key}=${encodeURIComponent(value)}; path=/; max-age=${maxAge}; SameSite=Lax`;
              if (window.location.protocol === 'https:') cookieStr += '; Secure';
              if (AUTH_COOKIE_DOMAIN !== 'localhost') cookieStr += `; domain=${AUTH_COOKIE_DOMAIN}`;
              document.cookie = cookieStr;
              try { localStorage.setItem(key, value); } catch(e) {}
            },
            removeItem: (key) => {
              let cookieStr = `${key}=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT`;
              if (AUTH_COOKIE_DOMAIN !== 'localhost') cookieStr += `; domain=${AUTH_COOKIE_DOMAIN}`;
              document.cookie = cookieStr;
              try { localStorage.removeItem(key); } catch(e) {}
            }
          }
        }
      });
    }

    async function initPage() {
      supabaseClient = initSupabase();
      if (!supabaseClient) {
        console.error('Failed to init Supabase');
        loadForums();
        return;
      }
      
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session?.user) {
          currentUser = session.user;
          updateHeaderForUser(session.user);
        }
      } catch (e) { console.error('Auth error:', e); }
      
      supabaseClient.auth.onAuthStateChange((event, session) => {
        if (session?.user) {
          currentUser = session.user;
          updateHeaderForUser(session.user);
        } else {
          currentUser = null;
          updateHeaderForGuest();
        }
      });
      
      setupEventListeners();
      loadForums();
    }

    function setupEventListeners() {
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          e.preventDefault();
          const newFilter = tab.dataset.filter;
          console.log(`ğŸ”˜ Filter tab clicked: ${newFilter}`);
          console.log(`ğŸ‘¤ Current user: ${currentUser?.id || 'NOT LOGGED IN'}`);
          
          // Update UI
          document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // Set filter
          currentFilter = newFilter;
          console.log(`ğŸ“‹ Filter changed to: ${currentFilter}`);
          
          // Load forums with new filter
          loadForums();
        });
      });
      
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentCategory = btn.dataset.category;
          loadForums();
        });
      });
      
      document.getElementById('searchBtn').addEventListener('click', doSearch);
      document.getElementById('searchInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') doSearch(); });
    }

    function doSearch() {
      const q = document.getElementById('searchInput').value.trim();
      if (q) { currentFilter = 'search'; loadForums(q); }
    }

    let currentPage = 1;
    let hasMore = true;
    let isLoading = false;
    let allForumsData = [];
    const PAGE_SIZE = 24;

    // Load forums with optional background refresh (doesn't show spinner or reset scroll)
    async function loadForums(search = null, isBackgroundRefresh = false) {
      if (isLoading) return;
      isLoading = true;
      
      const container = document.getElementById('forumsContainer');
      
      // Handle upcoming events filter separately
      if (currentFilter === 'upcoming' && !isBackgroundRefresh) {
        await loadUpcomingEvents();
        isLoading = false;
        return;
      }
      
      // Only show loading on initial load, not background refresh
      if (!isBackgroundRefresh) {
        currentPage = 1;
        hasMore = true;
        allForumsData = [];
        container.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>Loading forums...</p></div>';
      }
      
      try {
        // Build request params
        const params = new URLSearchParams({ filter: currentFilter, limit: PAGE_SIZE, page: isBackgroundRefresh ? 1 : currentPage });
        if (currentUser) {
          params.append('userId', currentUser.id);
          console.log(`ğŸ‘¤ Sending userId: ${currentUser.id}`);
        } else {
          console.log('âš ï¸ No currentUser - userId will not be sent');
        }
        if (currentCategory !== 'all') params.append('category', currentCategory);
        if (search) params.append('search', search);
        
        console.log(`ğŸŒ API Request: /.netlify/functions/list-forums?${params.toString()}`);
        console.log(`ğŸ” Current filter: "${currentFilter}", isBackgroundRefresh: ${isBackgroundRefresh}`);
        
        const res = await fetch(`/.netlify/functions/list-forums?${params}`);
        const data = await res.json();
        console.log(`ğŸ“¦ Response: ${data.forums?.length || 0} forums, filter: ${data.filter || currentFilter}, from params: ${params.get('filter')}`);
        console.log('ğŸ“¦ Response data:', JSON.stringify(data).substring(0, 200));
        if (!res.ok) throw new Error(data.error);
        
        // Show message if no forums found for "My Forums"
        if (currentFilter === 'joined') {
          console.log(`â­ My Forums filter - received ${data.forums?.length || 0} forums`);
          if (!data.forums || data.forums.length === 0) {
            const container = document.getElementById('forumsContainer');
            container.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">â­</div>
                <h2>No Forums Joined Yet</h2>
                <p>${data.message || 'You haven\'t joined any forums yet. Browse and click "Join" on forums you like!'}</p>
                <button class="create-btn" onclick="document.querySelector('[data-filter=top]').click()">ğŸ”¥ Browse Top Forums</button>
              </div>
            `;
            isLoading = false;
            console.log('â„¹ï¸ Showing empty state for My Forums - user has no memberships');
            return;
          } else {
            console.log(`âœ… User has ${data.forums.length} forums they've joined`);
          }
        }
        
        if (isBackgroundRefresh) {
          // Background refresh: just update live counts without re-rendering
          updateForumStats(data.forums);
        } else {
          allForumsData = data.forums || [];
          hasMore = data.pagination ? (data.pagination.page < data.pagination.totalPages) : (allForumsData.length >= PAGE_SIZE);
          renderForums(allForumsData);
        }
      } catch (err) {
        console.error('Error:', err);
        if (!isBackgroundRefresh) showEmptyState();
      } finally {
        isLoading = false;
      }
    }

    // Load more forums (for infinite scroll)
    async function loadMoreForums() {
      if (isLoading || !hasMore) return;
      isLoading = true;
      currentPage++;
      
      const loadMoreBtn = document.getElementById('loadMoreBtn');
      if (loadMoreBtn) loadMoreBtn.textContent = 'Loading...';
      
      try {
        const params = new URLSearchParams({ filter: currentFilter, limit: PAGE_SIZE, page: currentPage });
        if (currentUser) params.append('userId', currentUser.id);
        if (currentCategory !== 'all') params.append('category', currentCategory);
        
        const res = await fetch(`/.netlify/functions/list-forums?${params}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        
        const newForums = data.forums || [];
        hasMore = data.pagination ? (data.pagination.page < data.pagination.totalPages) : (newForums.length >= PAGE_SIZE);
        allForumsData = [...allForumsData, ...newForums];
        appendForums(newForums);
      } catch (err) {
        console.error('Error loading more:', err);
        currentPage--; // Revert page on error
      } finally {
        isLoading = false;
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        if (loadMoreBtn) loadMoreBtn.textContent = hasMore ? 'ğŸ“¥ Load More' : 'No more forums';
      }
    }

    // Update only the stats (live counts) without re-rendering - preserves scroll
    function updateForumStats(forums) {
      if (!forums?.length) return;
      
      const statsMap = new Map(forums.map(f => [f.slug, f]));
      
      document.querySelectorAll('.forum-card').forEach(card => {
        const href = card.getAttribute('href');
        const slug = href?.replace('/f/', '');
        const forum = statsMap.get(slug);
        
        if (forum) {
          // Update member count
          const memberStat = card.querySelector('.forum-card-stat:not(.live)');
          if (memberStat) memberStat.innerHTML = `ğŸ‘¥ ${formatNumber(forum.memberCount || 0)}`;
          
          // Update or add live indicator
          const statsContainer = card.querySelector('.forum-card-stats');
          let liveStat = card.querySelector('.forum-card-stat.live');
          
          if (forum.activeRoomCount > 0) {
            if (liveStat) {
              liveStat.innerHTML = `ğŸ”´ ${forum.activeRoomCount} live`;
            } else {
              const newLive = document.createElement('span');
              newLive.className = 'forum-card-stat live';
              newLive.innerHTML = `ğŸ”´ ${forum.activeRoomCount} live`;
              statsContainer?.appendChild(newLive);
            }
          } else if (liveStat) {
            liveStat.remove();
          }
        }
      });
      console.log('ğŸ“Š Forum stats updated silently');
    }

    function renderForumCard(f) {
      // Show role badge for "My Forums" view
      let roleBadge = '';
      if (currentFilter === 'joined' && f.userRole) {
        const roleColors = { owner: '#7c3aed', moderator: '#2563eb', member: '#059669' };
        const roleLabels = { owner: 'ğŸ‘‘ Owner', moderator: 'ğŸ›¡ï¸ Mod', member: 'âœ“ Member' };
        roleBadge = `<span class="role-badge" style="font-size:0.65rem;background:${roleColors[f.userRole] || '#6b7280'};color:white;padding:3px 8px;border-radius:var(--radius-sm);font-weight:var(--font-weight-bold);">${roleLabels[f.userRole] || f.userRole}</span>`;
      }
      
      return `
        <a href="/f/${f.slug}" class="forum-card" data-slug="${f.slug}">
          <div class="forum-card-banner" ${f.primaryColor ? `style="background:${f.primaryColor}"` : ''}>
            ${f.bannerUrl ? `<img src="${f.bannerUrl}" loading="lazy">` : ''}
            <div class="forum-card-icon">${f.iconUrl ? `<img src="${f.iconUrl}" loading="lazy">` : (categoryIcons[f.category] || 'ğŸ’¬')}</div>
          </div>
          <div class="forum-card-body">
            <div class="forum-card-name">${escapeHtml(f.name)}${f.isNsfw ? '<span class="nsfw-badge">NSFW</span>' : ''}${roleBadge}</div>
            <div class="forum-card-slug">f/${f.slug}</div>
            <div class="forum-card-desc">${escapeHtml(f.description || 'A community on ChatSpheres')}</div>
            <div class="forum-card-stats">
              <span class="forum-card-stat">ğŸ‘¥ ${formatNumber(f.memberCount || 0)}</span>
              ${f.activeRoomCount > 0 ? `<span class="forum-card-stat live">ğŸ”´ ${f.activeRoomCount} live</span>` : ''}
            </div>
          </div>
        </a>
      `;
    }

    function renderForums(forums) {
      const container = document.getElementById('forumsContainer');
      
      // Log current state for debugging
      console.log(`ğŸ¨ Rendering ${forums?.length || 0} forums, current filter: ${currentFilter}`);
      
      if (!forums?.length) { showEmptyState(); return; }
      
      const loadMoreHtml = hasMore ? `
        <div style="text-align: center; margin-top: var(--space-xl);">
          <button id="loadMoreBtn" class="create-btn" onclick="loadMoreForums()" style="background: var(--charcoal);">ğŸ“¥ Load More</button>
        </div>
      ` : '';
      
      container.innerHTML = '<div class="forums-grid">' + forums.map(f => renderForumCard(f)).join('') + '</div>' + loadMoreHtml;
    }

    function appendForums(forums) {
      if (!forums?.length) return;
      
      const grid = document.querySelector('.forums-grid');
      if (!grid) return;
      
      forums.forEach(f => {
        grid.insertAdjacentHTML('beforeend', renderForumCard(f));
      });
      
      // Update or remove load more button
      const loadMoreBtn = document.getElementById('loadMoreBtn');
      if (loadMoreBtn && !hasMore) {
        loadMoreBtn.parentElement.remove();
      }
    }

    function showEmptyState() {
      document.getElementById('forumsContainer').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸŒ</div>
          <h2>No Forums Yet!</h2>
          <p>Be the first to create a community on ChatSpheres</p>
          ${currentUser ? '<a href="/create-forum" class="create-btn">+ Create Forum</a>' : '<a href="/login.html?redirect=/create-forum" class="create-btn">Sign In to Create</a>'}
        </div>
      `;
    }

    function updateHeaderForUser(user) {
      document.getElementById('nav-guest-links').style.display = 'none';
      document.getElementById('nav-user-section').style.display = 'block';
      document.getElementById('header-gem-badge').style.display = 'flex';
      document.getElementById('nav-user-name').textContent = user.user_metadata?.name || user.user_metadata?.full_name || user.email?.split('@')[0] || 'User';
      document.getElementById('createCTA').style.display = 'flex';
      document.getElementById('joinedTab').style.display = 'inline-block';
      fetchGemBalance(user.id);
    }

    function updateHeaderForGuest() {
      document.getElementById('nav-guest-links').style.display = 'block';
      document.getElementById('nav-user-section').style.display = 'none';
      document.getElementById('header-gem-badge').style.display = 'none';
      document.getElementById('createCTA').style.display = 'none';
      document.getElementById('joinedTab').style.display = 'none';
    }

    async function fetchGemBalance(userId) {
      try {
        const res = await fetch(`/.netlify/functions/get-subscription?userId=${userId}`);
        if (res.ok) {
          const d = await res.json();
          document.getElementById('nav-user-gems').textContent = (d.totalGems || 0).toLocaleString();
          document.querySelector('.gem-count').textContent = (d.totalGems || 0).toLocaleString();
        }
      } catch (e) {}
    }

    window.handleLogout = async function() {
      if (supabaseClient) { await supabaseClient.auth.signOut(); window.location.reload(); }
    };

    function formatNumber(n) { return n >= 1e6 ? (n/1e6).toFixed(1)+'M' : n >= 1e3 ? (n/1e3).toFixed(1)+'K' : n.toString(); }
    function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t || ''; return d.innerHTML; }

    // ============================================
    // UPCOMING EVENTS FOR FORUMS
    // ============================================
    async function loadUpcomingEvents() {
      const container = document.getElementById('forumsContainer');
      container.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>Loading upcoming events...</p></div>';
      
      try {
        const response = await fetch('/.netlify/functions/schedule-room?upcoming=true');
        const data = await response.json();
        const events = data.events || [];
        
        if (events.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“…</div>
              <h2>No Upcoming Events</h2>
              <p>Be the first to schedule an event!</p>
              ${currentUser ? '<a href="/schedule-room.html" class="create-btn">ğŸ“… Schedule Event</a>' : '<a href="/login.html?redirect=/schedule-room.html" class="create-btn">Sign In to Schedule</a>'}
            </div>
          `;
          return;
        }
        
        const eventsHtml = events.map(event => renderEventCard(event)).join('');
        container.innerHTML = `
          <div class="forums-grid">${eventsHtml}</div>
          <div style="text-align: center; margin-top: var(--space-xl); padding: var(--space-lg); background: var(--rose); border-radius: var(--radius-lg);">
            <p style="margin-bottom: var(--space-sm);">Want to host your own event?</p>
            <a href="/schedule-room.html" class="create-btn" style="display: inline-block;">ğŸ“… Schedule an Event</a>
          </div>
        `;
      } catch (error) {
        console.error('Error loading upcoming events:', error);
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ˜•</div>
            <h2>Could not load events</h2>
            <p>Please try again later</p>
          </div>
        `;
      }
    }
    
    function renderEventCard(event) {
      const scheduledAt = new Date(event.scheduled_at);
      const now = new Date();
      const diffMs = scheduledAt - now;
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffHours / 24);
      
      let timeDisplay;
      if (diffDays > 0) {
        timeDisplay = `in ${diffDays} day${diffDays > 1 ? 's' : ''}`;
      } else if (diffHours > 0) {
        timeDisplay = `in ${diffHours} hour${diffHours > 1 ? 's' : ''}`;
      } else {
        const diffMins = Math.floor(diffMs / (1000 * 60));
        timeDisplay = diffMins > 0 ? `in ${diffMins} min` : 'Starting soon!';
      }
      
      const dateDisplay = scheduledAt.toLocaleDateString('en-US', { 
        weekday: 'short', 
        month: 'short', 
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
      });
      
      const isHost = currentUser && event.host_id === currentUser.id;
      
      const typeEmoji = event.room_type === 'creator' ? 'â­' : event.room_type === 'red' ? 'ğŸ”´' : 'ğŸŸ¢';
      const typeLabel = event.room_type === 'creator' ? 'Creator' : event.room_type === 'red' ? 'Debate' : 'Help';
      const forumBadge = event.forum_slug ? `<span style="font-size: 0.65rem; background: #8b5cf6; color: white; padding: 3px 8px; border-radius: var(--radius-sm); font-weight: var(--font-weight-bold);">ğŸŒ f/${escapeHtml(event.forum_slug)}</span>` : '';
      
      return `
        <div class="forum-card" style="cursor: pointer;" onclick="handleEventClick('${event.id}', ${isHost})">
          <div class="forum-card-banner" style="background: linear-gradient(135deg, var(--gold) 0%, var(--main-red) 100%);">
            ${event.cover_image_url ? `<img src="${event.cover_image_url}" loading="lazy">` : ''}
            <div class="forum-card-icon">${typeEmoji}</div>
          </div>
          <div class="forum-card-body">
            <div class="forum-card-name">
              ${escapeHtml(event.title)}
              <span style="font-size: 0.65rem; background: var(--gold); color: var(--charcoal); padding: 3px 8px; border-radius: var(--radius-sm); font-weight: var(--font-weight-bold);">${typeLabel}</span>
              ${forumBadge}
            </div>
            <div class="forum-card-slug">ğŸ“… ${dateDisplay} Â· ${timeDisplay}</div>
            ${event.forum_name ? `<p style="font-size: 0.8rem; color: #8b5cf6; margin-bottom: 4px;">ğŸ“ From: ${escapeHtml(event.forum_name)}</p>` : ''}
            <div class="forum-card-desc">${escapeHtml(event.description || 'An upcoming event on ChatSpheres')}</div>
            <div class="forum-card-stats">
              <span class="forum-card-stat">ğŸ‘¤ ${escapeHtml(event.host_name || 'Host')}</span>
              <span class="forum-card-stat">ğŸ”” ${event.reminderCount || 0} interested</span>
            </div>
            ${isHost ? `
              <button onclick="event.stopPropagation(); goLive('${event.id}')" class="create-btn" style="width: 100%; margin-top: var(--space-sm); justify-content: center;">
                ğŸ”´ Go Live Now
              </button>
            ` : ''}
          </div>
        </div>
      `;
    }
    
    function handleEventClick(eventId, isHost) {
      if (!isHost) {
        // Redirect to live page with upcoming filter to set reminder
        window.location.href = '/live.html?filter=upcoming';
      }
    }
    window.handleEventClick = handleEventClick;
    
    async function goLive(eventId) {
      if (!currentUser) {
        alert('Please sign in to go live');
        return;
      }
      
      try {
        const response = await fetch('/.netlify/functions/schedule-room', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'go-live',
            eventId,
            hostId: currentUser.id,
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          window.location.href = `/index.html?room=${data.roomId}&mode=participant&roomType=creator&host=true`;
        } else {
          throw new Error(data.error || 'Failed to go live');
        }
      } catch (error) {
        console.error('Error going live:', error);
        alert('Failed to start event: ' + error.message);
      }
    }
    window.goLive = goLive;

    // Auto-refresh forum list every 30 seconds to update live room counts
    // Uses background refresh to not interrupt user's scroll position
    let forumsRefreshInterval = null;
    function startForumsRefresh() {
      if (forumsRefreshInterval) clearInterval(forumsRefreshInterval);
      forumsRefreshInterval = setInterval(() => {
        // Background refresh: just update stats without re-rendering
        console.log('ğŸ”„ Background refresh: updating forum stats...');
        loadForums(null, true); // true = background refresh
      }, 30000); // Every 30 seconds (less frequent to reduce load)
    }

    // Start refresh after initial load
    setTimeout(startForumsRefresh, 5000);

    // Stop refresh when page is hidden, restart when visible
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        if (forumsRefreshInterval) clearInterval(forumsRefreshInterval);
      } else {
        startForumsRefresh();
      }
    });
    
    // Infinite scroll: auto-load more when near bottom
    let scrollDebounce = null;
    window.addEventListener('scroll', () => {
      if (scrollDebounce) return;
      scrollDebounce = setTimeout(() => {
        scrollDebounce = null;
        // Check if near bottom (within 500px of bottom)
        const scrollBottom = window.innerHeight + window.scrollY;
        const docHeight = document.documentElement.scrollHeight;
        if (docHeight - scrollBottom < 500 && hasMore && !isLoading) {
          console.log('ğŸ“œ Infinite scroll: loading more forums...');
          loadMoreForums();
        }
      }, 150);
    }, { passive: true });

    // Init with retry
    (function() {
      let a = 0;
      function tryInit() {
        a++;
        const c = window.__CHATSPHERES_CONFIG__ || {};
        if ((c.supabase?.url || c.SUPABASE_URL) && (c.supabase?.anonKey || c.SUPABASE_ANON_KEY)) {
          initPage();
        } else if (a < 15) {
          setTimeout(tryInit, 300);
        } else {
          loadForums();
        }
      }
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', tryInit);
      else tryInit();
    })();
  </script>

<!-- Ad Management Script -->
<script src="/assets/js/ads.js?v=3"></script>

<!-- Monetag ads loaded dynamically by ads.js after subscription check -->

</body>
</html>
