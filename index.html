<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ChatSpheres - Join Your Sphere</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'main-red': '#e63946',
            'gold': '#FFD166',
            'rose': '#FFB6B9',
            'light-rose': '#FCE2E5',
            'charcoal': '#22223B',
            'bg-light': '#F8F9FA'
          },
          fontFamily: {
            'nunito': ['Nunito', 'sans-serif']
          }
        }
      }
    }
  </script>

  <style>
    * {
      font-family: 'Nunito', sans-serif;
    }
    
    .video-placeholder {
      background: linear-gradient(135deg, #22223B 0%, #2a2a4a 100%);
    }
    
    .chatspheres-pattern {
      position: relative;
      overflow: hidden;
    }
    
    .chatspheres-pattern::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 30% 70%, rgba(230, 57, 70, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 70% 30%, rgba(255, 209, 102, 0.1) 0%, transparent 50%);
      pointer-events: none;
    }
    
    .vesica-accent {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      opacity: 0.1;
      pointer-events: none;
    }
    
    .timer-glow {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .new-spark-btn {
      background: #FFD166;
      color: #22223B;
      transition: all 0.2s ease;
    }
    
    .new-spark-btn:hover {
      background: #e63946;
      color: white;
      transform: scale(1.05);
    }
    
    .topic-badge {
      background: linear-gradient(135deg, #e63946 0%, #FFD166 100%);
      color: white;
    }

    /* Waiting overlay styles */
    #waiting-overlay {
      position: absolute;
      top: 20px;
      right: 20px;
      background: white;
      border: 3px solid #fff;
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(230, 57, 70, 0.15);
      padding: 1.5rem 2rem;
      z-index: 9999;
      text-align: center;
      width: 320px;
    }

    #waiting-overlay .waiting-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #e63946;
      margin-bottom: 0.5rem;
    }

    #waiting-overlay .waiting-subtitle {
      font-size: 0.95rem;
      color: #22223B;
      margin-bottom: 1rem;
    }

    #waiting-overlay .status-badge {
      background: #FFD166;
      color: #22223B;
      padding: 0.5rem 1rem;
      border-radius: 100px;
      font-weight: 700;
      font-size: 0.85rem;
    }

    .loading-dots::after {
      content: '';
      animation: loading-dots 1.5s infinite;
      margin-left: 0.25rem;
    }

    @keyframes loading-dots {
      0% { content: ''; }
      25% { content: '.'; }
      50% { content: '..'; }
      75% { content: '...'; }
      100% { content: ''; }
    }

    .control-btn {
      transition: all 0.2s ease;
    }

    .control-btn.active {
      background: #e63946 !important;
      color: white !important;
    }

    @media (max-width: 768px) {
      #waiting-overlay {
        width: 200px;
        top: 8px;
        left: 8px;
        right: auto;
        padding: 0.75rem 1rem;
      }
    }
  </style>
</head>
<body class="bg-bg-light dark:bg-charcoal min-h-screen font-nunito">

<!-- Waiting Overlay -->
<div id="waiting-overlay">
  <div class="mb-4">
    <svg viewBox="0 0 64 64" width="64" height="64" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="24" cy="32" r="20" stroke="#fff" stroke-width="6"/>
      <circle cx="40" cy="32" r="20" stroke="#fff" stroke-width="6"/>
      <circle cx="24" cy="32" r="18" stroke="#e63946" stroke-width="4" fill="none"/>
      <circle cx="40" cy="32" r="18" stroke="#e63946" stroke-width="4" fill="none"/>
    </svg>
  </div>
  <div class="text-2xl mb-2">üê±‚ú®</div>
  <div class="waiting-title">preparing your sphere</div>
  <div class="waiting-subtitle">joining room...</div>
  <div class="status-badge">
    Connecting<span class="loading-dots"></span>
  </div>
  
  <div style="margin-top: 1rem; font-size: 0.85rem; color: #222;">
    <strong>Topic:</strong> <span id="topic-text">Loading...</span><br>
    <strong>Description:</strong> <span id="topic-description">Please wait...</span>
  </div>
</div>

<!-- Main Video Chat Interface -->
<div id="video-interface" class="hidden">
  <!-- Header -->
  <header class="bg-white dark:bg-charcoal shadow-sm border-b border-gray-200 dark:border-gray-700 px-4 py-3">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <!-- Logo -->
      <div class="flex items-center space-x-3">
        <svg viewBox="0 0 64 64" width="40" height="40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="24" cy="32" r="20" stroke="#fff" stroke-width="6"/>
          <circle cx="40" cy="32" r="20" stroke="#fff" stroke-width="6"/>
          <circle cx="24" cy="32" r="18" stroke="#e63946" stroke-width="4" fill="none"/>
          <circle cx="40" cy="32" r="18" stroke="#e63946" stroke-width="4" fill="none"/>
        </svg>
        <h1 class="text-xl font-bold text-charcoal dark:text-white">chatspheres</h1>
      </div>
      
      <!-- Timer -->
      <div class="flex items-center space-x-2">
        <div class="timer-glow bg-main-red text-white px-4 py-2 rounded-full font-bold text-lg">
          <span id="timer-header">60:00</span>
        </div>
        <span class="text-sm text-gray-600 dark:text-gray-300 hidden sm:block">time remaining</span>
      </div>
    </div>
  </header>

  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Topic Section -->
    <div class="mb-6 text-center">
      <div class="topic-badge inline-block px-6 py-3 rounded-full font-bold text-lg mb-3">
        üåü <span id="topic-display">Loading Topic...</span>
      </div>
      <p class="text-charcoal dark:text-gray-300 text-base max-w-2xl mx-auto" id="topic-desc-display">
        Loading description...
      </p>
    </div>

    <!-- Main Content Grid -->
    <div class="grid lg:grid-cols-3 gap-6">
      <!-- Video Section -->
      <div class="lg:col-span-2 space-y-4">
        <!-- Remote Video -->
        <div class="relative bg-charcoal rounded-2xl overflow-hidden aspect-video chatspheres-pattern">
          <video id="remote-video" class="w-full h-full object-cover hidden" autoplay playsinline></video>
          <video id="screen-share-video" class="w-full h-full object-cover hidden" autoplay playsinline></video>
          
          <div id="remote-placeholder" class="absolute inset-0 flex items-center justify-center video-placeholder">
            <svg class="vesica-accent" viewBox="0 0 64 64" width="120" height="120" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="24" cy="32" r="20" stroke="#fff" stroke-width="3"/>
              <circle cx="40" cy="32" r="20" stroke="#fff" stroke-width="3"/>
              <circle cx="24" cy="32" r="18" stroke="#e63946" stroke-width="2" fill="none"/>
              <circle cx="40" cy="32" r="18" stroke="#e63946" stroke-width="2" fill="none"/>
            </svg>
            
            <div class="text-center text-white relative z-10">
              <div class="w-16 h-16 mx-auto mb-4 bg-main-red rounded-full flex items-center justify-center shadow-lg">
                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                </svg>
              </div>
              <p class="font-bold text-lg text-white">Waiting for your chat partner...</p>
              <p class="text-sm text-gold mt-1">üê± They might be as curious as a cat about this topic!</p>
            </div>
          </div>

          <!-- Participant Info -->
          <div id="remote-info" class="absolute top-4 left-4 bg-main-red text-white px-4 py-2 rounded-full text-sm font-semibold shadow-lg">
            <span id="remote-name">Guest</span>
          </div>
        </div>

        <!-- Local Video -->
        <div class="relative bg-charcoal rounded-2xl overflow-hidden aspect-video sm:aspect-[4/3] lg:aspect-video chatspheres-pattern">
          <video id="local-video" class="w-full h-full object-cover scale-x-[-1]" autoplay playsinline muted></video>
          
          <div id="local-placeholder" class="absolute inset-0 flex items-center justify-center video-placeholder">
            <svg class="vesica-accent" viewBox="0 0 64 64" width="80" height="80" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="24" cy="32" r="20" stroke="#fff" stroke-width="2"/>
              <circle cx="40" cy="32" r="20" stroke="#fff" stroke-width="2"/>
              <circle cx="24" cy="32" r="18" stroke="#FFD166" stroke-width="2" fill="none"/>
              <circle cx="40" cy="32" r="18" stroke="#FFD166" stroke-width="2" fill="none"/>
            </svg>
            
            <div class="text-center text-white relative z-10">
              <div class="w-12 h-12 mx-auto mb-3 bg-gold rounded-full flex items-center justify-center shadow-lg">
                <svg class="w-6 h-6 text-charcoal" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                </svg>
              </div>
              <p class="font-bold text-gold">You</p>
            </div>
          </div>

          <!-- Enhanced Controls -->
          <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2">
            <button id="mic-btn" class="control-btn bg-charcoal bg-opacity-80 hover:bg-main-red text-white p-3 rounded-full shadow-lg">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"/>
              </svg>
            </button>
            <button id="camera-btn" class="control-btn bg-charcoal bg-opacity-80 hover:bg-main-red text-white p-3 rounded-full shadow-lg">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/>
              </svg>
            </button>
            <button id="screen-share-btn" class="control-btn bg-charcoal bg-opacity-80 hover:bg-gold text-white p-3 rounded-full shadow-lg">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v8a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm2 3a1 1 0 000 2h.01a1 1 0 100-2H5zm3 0a1 1 0 000 2h.01a1 1 0 100-2H8zm3 0a1 1 0 000 2h.01a1 1 0 100-2H11z" clip-rule="evenodd"/>
              </svg>
            </button>
            <button id="settings-btn" class="control-btn bg-charcoal bg-opacity-80 hover:bg-gold text-white p-3 rounded-full shadow-lg">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
              </svg>
            </button>
            <button id="leave-btn" class="control-btn bg-main-red hover:bg-red-600 text-white p-3 rounded-full shadow-lg">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414L9.586 11l-2.293 2.293a1 1 0 001.414 1.414L10 12.414l1.293 1.293a1 1 0 001.414-1.414L11.414 11l2.293-2.293z" clip-rule="evenodd"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Device Settings Panel -->
        <div id="settings-panel" class="hidden bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-200 dark:border-gray-700">
          <h3 class="text-lg font-bold text-charcoal dark:text-white mb-4">üéõÔ∏è Device Settings</h3>
          
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-charcoal dark:text-white mb-2">üìπ Camera</label>
              <select id="camera-selector" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-main-red bg-white dark:bg-gray-700 text-charcoal dark:text-white">
                <option disabled selected>Select camera...</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-semibold text-charcoal dark:text-white mb-2">üé§ Microphone</label>
              <select id="mic-selector" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-main-red bg-white dark:bg-gray-700 text-charcoal dark:text-white">
                <option disabled selected>Select microphone...</option>
              </select>
            </div>
          </div>
          
          <div class="mt-4 text-center">
            <button id="close-settings" class="new-spark-btn px-6 py-2 rounded-full font-bold text-sm">Close Settings</button>
          </div>
        </div>
      </div>

      <!-- Conversation Sparks Sidebar -->
      <div class="lg:col-span-1">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-200 dark:border-gray-700">
          <!-- Header -->
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-bold text-charcoal dark:text-white flex items-center">
              ‚ú® conversation sparks
            </h3>
            <button 
              id="newSparkBtn" 
              class="new-spark-btn px-4 py-2 rounded-full font-bold text-sm"
              onclick="generateNewSparks()"
            >
              üîÑ new spark
            </button>
          </div>

          <!-- Single Conversation Spark -->
          <div id="sparksContainer">
            <div class="relative">
              <!-- Main Spark Display -->
              <div id="currentSpark" class="bg-gradient-to-br from-light-rose to-rose p-6 rounded-2xl shadow-lg border-2 border-transparent hover:border-main-red transition-all cursor-pointer" onclick="selectCurrentSpark()">
                <div class="flex items-start justify-between mb-3">
                  <div class="bg-main-red text-white px-3 py-1 rounded-full text-xs font-bold">
                    SPARK #<span id="sparkNumber">1</span>
                  </div>
                  <div class="text-main-red">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                  </div>
                </div>
                <blockquote class="text-charcoal font-bold text-base leading-relaxed italic">
                  "<span id="sparkText">If you could have a conversation with your future self from 10 years from now, what would you want to ask them about the choices you're making today?</span>"
                </blockquote>
                <div class="mt-4 text-center">
                  <span class="text-xs text-charcoal font-semibold opacity-70">üëÜ Click to highlight for both users</span>
                </div>
              </div>

              <!-- Navigation Controls -->
              <div class="flex justify-between items-center mt-4">
                <button 
                  id="prevSparkBtn"
                  onclick="navigateSpark('prev')" 
                  class="flex items-center space-x-2 bg-gold hover:bg-main-red text-charcoal hover:text-white px-4 py-2 rounded-full font-bold text-sm transition-all"
                >
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  <span>Previous</span>
                </button>
                
                <div class="flex space-x-2">
                  <span id="sparkDot1" class="w-2 h-2 bg-main-red rounded-full transition-all"></span>
                  <span id="sparkDot2" class="w-2 h-2 bg-gray-300 rounded-full transition-all"></span>
                  <span id="sparkDot3" class="w-2 h-2 bg-gray-300 rounded-full transition-all"></span>
                </div>
                
                <button 
                  id="nextSparkBtn"
                  onclick="navigateSpark('next')" 
                  class="flex items-center space-x-2 bg-gold hover:bg-main-red text-charcoal hover:text-white px-4 py-2 rounded-full font-bold text-sm transition-all"
                >
                  <span>Next</span>
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- User Prompts Section -->
          <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-600">
            <h4 class="text-sm font-bold text-charcoal dark:text-white mb-3">Custom Spark Request</h4>
            <div class="space-y-3">
              <input 
                type="text" 
                id="userPrompt"
                placeholder="e.g., 'questions about career changes'"
                class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-main-red focus:border-transparent bg-white dark:bg-gray-700 text-charcoal dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
              >
              <button 
                onclick="generateCustomSparks()" 
                class="w-full new-spark-btn py-3 rounded-xl font-bold text-sm"
              >
                ‚ö° Generate Custom Sparks
              </button>
            </div>
          </div>

          <!-- Fun Facts -->
          <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-600">
            <div class="text-center text-xs text-gray-500 dark:text-gray-400">
              <p>üí° Like a Pok√©mon evolving through battles,</p>
              <p>great conversations evolve through curiosity!</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Sticky Timer -->
<div id="stickyTimer" class="fixed top-4 right-4 z-50 transition-all duration-300 opacity-0 transform translate-y-[-20px]">
  <div class="timer-glow bg-main-red text-white px-3 py-2 rounded-full font-bold text-sm shadow-lg">
    <span id="timer">60:00</span>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="fixed bottom-4 right-4 bg-main-red text-white px-6 py-3 rounded-xl shadow-lg transform translate-y-full transition-transform hidden z-40">
  <p id="toastMessage"></p>
</div>

<script src="https://unpkg.com/@daily-co/daily-js"></script>
<script>
  // Firebase config - Main database
  const firebaseConfig = {
    apiKey: "AIzaSyBno0Zb0MD91F2PzTlSFYnvBQNf8Nv_-wQ",
    authDomain: "chatspheresfirebasedb.firebaseapp.com",
    databaseURL: "https://chatspheresfirebasedb-default-rtdb.firebaseio.com",
    projectId: "chatspheresfirebasedb",
    storageBucket: "chatspheresfirebasedb.firebasestorage.app",
    messagingSenderId: "224075573732",
    appId: "1:224075573732:web:47e014622bd263fb2abff1",
    measurementId: "G-PJ2X2LSEF9"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Prompts Firebase config - Secondary database
  const promptsFirebaseConfig = {
    apiKey: "AIzaSyBno0Zb0MD91F2PzTlSFYnvBQNf8Nv_-wQ", // Using same key
    authDomain: "chatspheresfirebasepromptsai.firebaseapp.com",
    databaseURL: "https://chatspheresfirebasepromptsai-default-rtdb.firebaseio.com",
    projectId: "chatspheresfirebasepromptsai",
    storageBucket: "chatspheresfirebasepromptsai.firebasestorage.app",
    messagingSenderId: "224075573732",
    appId: "1:224075573732:web:47e014622bd263fb2abff2"
  };

  const promptsApp = firebase.initializeApp(promptsFirebaseConfig, "prompts");
  const promptsDb = promptsApp.database();

  // Netlify Functions configuration (API key securely stored as env variable)

  // Global variables
  let call = null;
  let localVideo = null;
  let remoteVideo = null;
  let screenShareVideo = null;
  let isCameraOn = true;
  let isMicOn = false; // ‚úÖ Start muted by default (more typical for web apps)
  let isScreenSharing = false;
  let timeRemaining = 60 * 60; // 1 hour
  let timerInterval = null;

  // Sparks data
  let currentSparks = [
    "If you could have a conversation with your future self from 10 years from now, what would you want to ask them about the choices you're making today?",
    "What's something you believed strongly about life when you were younger that you've completely changed your mind about now?",
    "If you had to choose one value to guide every major decision for the rest of your life, what would it be and why?"
  ];
  let currentSparkIndex = 0;
  let sparkIsSelected = false;

  const roomUrl = new URLSearchParams(window.location.search).get('room');

  if (!roomUrl) {
    document.body.innerHTML = `
      <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:linear-gradient(135deg,#F8F9FA 0%,#FCE2E5 100%);padding:2rem;font-family:'Nunito',sans-serif;">
        <div style="background:white;padding:2rem;border-radius:24px;box-shadow:0 8px 32px rgba(230,57,70,0.15);border:3px solid #FFB6B9;text-align:center;max-width:400px;">
          <div style="margin-bottom:1rem;">
            <svg viewBox="0 0 64 64" width="64" height="64" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="24" cy="32" r="20" stroke="#fff" stroke-width="6"/>
              <circle cx="40" cy="32" r="20" stroke="#fff" stroke-width="6"/>
              <circle cx="24" cy="32" r="18" stroke="#e63946" stroke-width="4" fill="none"/>
              <circle cx="40" cy="32" r="18" stroke="#e63946" stroke-width="4" fill="none"/>
            </svg>
          </div>
          <div style="font-size:2rem;margin:1rem 0;">üòø</div>
          <h1 style="color:#e63946;font-weight:700;margin-bottom:0.5rem;font-size:1.3rem;">no sphere url provided</h1>
          <p style="color:#22223B;">please create a sphere first to start chatting</p>
        </div>
      </div>
    `;
  } else {
    initializeVideoChat();
  }

  // Load room info first
  async function loadRoomInfo() {
    const urlParam = decodeURIComponent(roomUrl);
    console.log("üîç Looking for room URL:", urlParam);

    try {
      // ‚úÖ FIXED: Pass room URL as query parameter
      const apiUrl = `https://x8ki-letl-twmt.n7.xano.io/api:6PAcsVDu/get-room-info?room_url=${encodeURIComponent(urlParam)}`;
      console.log("üåê API URL:", apiUrl);
      
      let response = await fetch(apiUrl);
      
      if (!response.ok) {
        throw new Error(`API returned ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log("üì¶ API Response:", data);
      
      // Handle the actual API response structure
      if (data.topic) {
        const topic = data.topic.charAt(0).toUpperCase() + data.topic.slice(1);
        // Handle null description for matchmaking rooms
        const description = data.description || `Discover and discuss fascinating aspects of ${data.topic.toLowerCase()}!`;
        
        console.log("‚úÖ Found topic:", topic);
        console.log("‚úÖ Found description:", description);
        console.log("üéØ Room type:", data.room_type);
        
        updateTopicDisplay(topic, description);
        return;
      } else {
        console.log("‚ùå API response missing topic:", data);
      }
      
    } catch (error) {
      console.error("‚ùå API Error:", error);
      console.log("üîÑ Using fallback topic because room not found or API error");
    }
    
    // Fallback: Use default topic
    console.log("üîÑ Using fallback topic");
    updateTopicDisplay("General Chat", "Connect and have meaningful conversations!");
  }

  function updateTopicDisplay(topic, description) {
    const elements = [
      'topic-text', 'topic-description', 
      'topic-display', 'topic-desc-display'
    ];
    
    elements.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        if (id.includes('description') || id.includes('desc')) {
          element.innerText = description;
        } else {
          element.innerText = topic;
        }
      }
    });
    
    console.log("‚úÖ Updated topic:", topic);
    console.log("‚úÖ Updated description:", description);
  }

  async function initializeVideoChat() {
    // Load room info first
    await loadRoomInfo();
    
    // Firebase presence tracking
    const roomId = btoa(roomUrl);
    const userId = `user_${Math.random().toString(36).slice(2)}_${Date.now()}`;
    const roomRef = db.ref(`rooms/${roomId}`);

    // ‚úÖ Create Daily call object with proper audio configuration
    call = Daily.createCallObject({
      audioSource: true,  // ‚úÖ Ensure audio is enabled by default
      videoSource: true   // ‚úÖ Ensure video is enabled by default
    });
    
    // Set up event listeners
    call.on('joined-meeting', handleJoinedMeeting);
    call.on('participant-joined', handleParticipantJoined);
    call.on('participant-left', handleParticipantLeft);
    call.on('participant-updated', handleParticipantUpdated);
    call.on('track-started', handleTrackStarted);
    call.on('track-stopped', handleTrackStopped);
    call.on('app-message', handleAppMessage);
    call.on('error', handleError);
    call.on('camera-error', handleCameraError);

    try {
      // Join the call
      await call.join({ url: roomUrl });
      
      // Set up Firebase presence
      await db.ref(`rooms/${roomId}/${userId}`).set(true);
      
      roomRef.on('value', (snapshot) => {
        const users = snapshot.val();
        const count = users ? Object.keys(users).length : 0;
        console.log(`üë• User count: ${count}`);
      });

      // Clean up on page unload
      window.addEventListener('beforeunload', () => {
        db.ref(`rooms/${roomId}/${userId}`).remove();
        if (call) call.leave();
      });

    } catch (error) {
      console.error('Failed to join call:', error);
      showToast('Failed to join the video call. Please try refreshing the page.');
    }
  }

  function handleJoinedMeeting(event) {
    console.log('‚úÖ Joined meeting successfully');
    
    // ‚úÖ CRITICAL: Check and log initial audio/video states
    console.log("üé§ Initial microphone state:", call.localAudio());
    console.log("üìπ Initial camera state:", call.localVideo());
    
    // ‚úÖ Update the local state variables to match Daily's state
    isMicOn = call.localAudio();
    isCameraOn = call.localVideo();
    
    console.log("üé§ Updated isMicOn to:", isMicOn);
    console.log("üìπ Updated isCameraOn to:", isCameraOn);
    
    // ‚úÖ Update button states to match
    const micBtn = document.getElementById('mic-btn');
    const cameraBtn = document.getElementById('camera-btn');
    
    if (isMicOn) {
      micBtn.classList.remove('active');
      console.log("üé§ Microphone button set to ON state");
    } else {
      micBtn.classList.add('active');
      console.log("üé§ Microphone button set to MUTED state");
    }
    
    if (isCameraOn) {
      cameraBtn.classList.remove('active');
      console.log("üìπ Camera button set to ON state");
    } else {
      cameraBtn.classList.add('active');
      console.log("üìπ Camera button set to OFF state");
    }
    
    // Hide waiting overlay and show video interface
    document.getElementById('waiting-overlay').style.display = 'none';
    document.getElementById('video-interface').classList.remove('hidden');
    
    // Start timer
    startTimer();
    
    // Set up local video
    setupLocalVideo();
    
    // ‚úÖ Start audio level monitoring immediately if mic is on
    if (isMicOn) {
      console.log("üé§ Starting audio monitoring since mic is ON");
      startAudioLevelMonitoring();
    }
    
    // Request permissions first, then set up device selectors
    requestPermissionsAndSetupDevices();
    
    // Initialize AI sparks system
    initializeSparks();
    
    showToast('üéâ Welcome to your ChatSpheres room!');
  }

  async function requestPermissionsAndSetupDevices() {
    try {
      console.log("üîê Requesting media permissions...");
      
      // ‚úÖ CRITICAL: Request both camera AND microphone permissions together
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: true, 
        audio: true 
      });
      
      console.log("‚úÖ Permissions granted successfully!");
      console.log("üé§ Audio tracks:", stream.getAudioTracks().length);
      console.log("üìπ Video tracks:", stream.getVideoTracks().length);
      
      // Test audio track properties
      const audioTracks = stream.getAudioTracks();
      if (audioTracks.length > 0) {
        console.log("üé§ Audio track label:", audioTracks[0].label);
        console.log("üé§ Audio track enabled:", audioTracks[0].enabled);
        console.log("üé§ Audio track ready state:", audioTracks[0].readyState);
      }
      
      // Stop the temporary stream
      stream.getTracks().forEach(track => track.stop());
      
      // Now set up device selectors with proper labels
      setTimeout(setupDeviceSelectors, 1000);
      
    } catch (error) {
      console.error("‚ùå Permission denied or device error:", error);
      
      // Provide specific error guidance
      if (error.name === 'NotAllowedError') {
        showToast('‚ùå Please allow camera and microphone access and reload the page');
      } else if (error.name === 'NotFoundError') {
        showToast('‚ùå No camera or microphone found. Please check your devices.');
      } else {
        showToast('‚ùå Camera/mic permissions needed. Error: ' + error.name);
      }
      
      // Still try to set up selectors (may have generic names)
      setTimeout(setupDeviceSelectors, 1000);
    }
  }

  function handleParticipantJoined(event) {
    console.log('üëã Participant joined:', event.participant.user_name);
    updateRemoteInfo(event.participant.user_name || 'Guest');
    showToast(`üëã ${event.participant.user_name || 'Guest'} joined the call!`);
  }

  function handleParticipantLeft(event) {
    console.log('üëã Participant left:', event.participant.user_name);
    hideRemoteVideo();
    showToast(`üëã ${event.participant.user_name || 'Guest'} left the call`);
  }

  function handleParticipantUpdated(event) {
    console.log('üîÑ Participant updated:', event.participant);
    // Handle track updates
    const tracks = event.participant.tracks;
    if (tracks) {
      if (tracks.video && tracks.video.persistentTrack) {
        if (!event.participant.local) {
          setupRemoteVideo(tracks.video.persistentTrack);
        }
      }
      if (tracks.screenVideo && tracks.screenVideo.persistentTrack) {
        if (!event.participant.local) {
          setupScreenShareVideo(tracks.screenVideo.persistentTrack);
        }
      }
    }
  }

  function handleTrackStarted(event) {
    console.log('üé• Track started:', event);
    
    if (event.participant.local) {
      if (event.track.kind === 'video') {
        setupLocalVideo(event.track);
      }
    } else {
      if (event.track.kind === 'video') {
        if (event.track.label.includes('screen')) {
          setupScreenShareVideo(event.track);
        } else {
          setupRemoteVideo(event.track);
        }
      }
    }
  }

  function handleTrackStopped(event) {
    console.log('üõë Track stopped:', event);
    
    if (!event.participant.local && event.track.kind === 'video') {
      if (event.track.label.includes('screen')) {
        hideScreenShareVideo();
      } else {
        hideRemoteVideo();
      }
    }
  }

  function handleAppMessage(event) {
    console.log('üì® App message received:', event);
    
    if (event.data.type === 'spark-selected') {
      // Sync spark selection across participants
      currentSparkIndex = event.data.sparkIndex;
      sparkIsSelected = event.data.isSelected;
      updateSparkDisplay();
      if (sparkIsSelected) {
        const currentSparkEl = document.getElementById('currentSpark');
        currentSparkEl.classList.add('ring-4', 'ring-gold');
        currentSparkEl.style.background = 'linear-gradient(135deg, #FFD166 0%, #FFB6B9 100%)';
      }
    } else if (event.data.type === 'sparks-updated') {
      // Sync new sparks from other participant
      console.log("üì® Receiving updated sparks from other participant");
      currentSparks = event.data.sparks;
      currentSparkIndex = 0;
      updateSparkDisplay();
      showToast(`‚ú® Partner generated new sparks for "${event.data.topic}"!`);
    }
  }

  function handleError(event) {
    console.error('‚ùå Daily.co error:', event);
    showToast('Video call error: ' + event.errorMsg);
  }

  // ‚úÖ NEW: Handle camera/microphone permission errors
  function handleCameraError(event) {
    console.error('üé•‚ùå Camera/Microphone error:', event);
    
    const { error } = event;
    
    switch (error.type) {
      case 'permissions':
        if (error.blockedMedia.includes('audio')) {
          console.error('üé§‚ùå Microphone permissions denied!');
          showToast('‚ùå Microphone access denied. Please allow microphone access and reload.');
        }
        if (error.blockedMedia.includes('video')) {
          console.error('üìπ‚ùå Camera permissions denied!');
          showToast('‚ùå Camera access denied. Please allow camera access and reload.');
        }
        break;
        
      case 'cam-in-use':
      case 'mic-in-use':
      case 'cam-mic-in-use':
        console.error('üîí Device in use by another application');
        showToast('‚ùå Camera or microphone is being used by another app. Please close other apps and try again.');
        break;
        
      case 'not-found':
        if (error.missingMedia.includes('audio')) {
          console.error('üé§‚ùå No microphone found!');
          showToast('‚ùå No microphone detected. Please check your device.');
        }
        if (error.missingMedia.includes('video')) {
          console.error('üìπ‚ùå No camera found!');
          showToast('‚ùå No camera detected. Please check your device.');
        }
        break;
        
      default:
        console.error('‚ùå Unknown camera error:', error);
        showToast('‚ùå Device error: ' + error.msg);
    }
  }

  function setupLocalVideo(track) {
    localVideo = document.getElementById('local-video');
    const placeholder = document.getElementById('local-placeholder');
    
    try {
      if (track && track instanceof MediaStreamTrack) {
        // Use provided track if it's valid
        localVideo.srcObject = new MediaStream([track]);
      } else {
        // Get local video track from call participants
        const localParticipant = call.participants().local;
        if (localParticipant && localParticipant.tracks && localParticipant.tracks.video) {
          const videoTrack = localParticipant.tracks.video.track || localParticipant.tracks.video.persistentTrack;
          if (videoTrack && videoTrack instanceof MediaStreamTrack) {
            localVideo.srcObject = new MediaStream([videoTrack]);
          }
        }
      }
      
      if (isCameraOn && localVideo.srcObject) {
        localVideo.style.display = 'block';
        placeholder.style.display = 'none';
      } else {
        localVideo.style.display = 'none';
        placeholder.style.display = 'flex';
      }
    } catch (error) {
      console.error("‚ùå Error setting up local video:", error);
      // Show placeholder on error
      localVideo.style.display = 'none';
      placeholder.style.display = 'flex';
    }
  }

  function setupRemoteVideo(track) {
    remoteVideo = document.getElementById('remote-video');
    const placeholder = document.getElementById('remote-placeholder');
    
    remoteVideo.srcObject = new MediaStream([track]);
    remoteVideo.style.display = 'block';
    placeholder.style.display = 'none';
  }

  function setupScreenShareVideo(track) {
    screenShareVideo = document.getElementById('screen-share-video');
    const remoteVideo = document.getElementById('remote-video');
    
    screenShareVideo.srcObject = new MediaStream([track]);
    screenShareVideo.style.display = 'block';
    remoteVideo.style.display = 'none';
  }

  function hideRemoteVideo() {
    const remoteVideo = document.getElementById('remote-video');
    const placeholder = document.getElementById('remote-placeholder');
    
    remoteVideo.style.display = 'none';
    placeholder.style.display = 'flex';
  }

  function hideScreenShareVideo() {
    const screenShareVideo = document.getElementById('screen-share-video');
    const remoteVideo = document.getElementById('remote-video');
    
    screenShareVideo.style.display = 'none';
    remoteVideo.style.display = 'block';
  }

  function updateRemoteInfo(name) {
    document.getElementById('remote-name').textContent = name;
  }

  async function setupDeviceSelectors() {
    try {
      console.log("üîß Setting up device selectors...");
      
      // Wait a bit for devices to be ready
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const selectedDevices = await call.getInputDevices();
      const { devices: allDevices } = await call.enumerateDevices();
      
      console.log("üì± Selected devices:", selectedDevices);
      console.log("üì± All devices:", allDevices);

      const cameraSelector = document.getElementById('camera-selector');
      const micSelector = document.getElementById('mic-selector');

      if (!cameraSelector || !micSelector) {
        console.error("‚ùå Settings selectors not found in DOM");
        return;
      }

      // Setup camera selector
      cameraSelector.innerHTML = '<option disabled selected>Select camera...</option>';
      const videoDevices = allDevices.filter(d => d.kind === 'videoinput');
      console.log("üìπ Video devices found:", videoDevices.length);
      
      videoDevices.forEach(device => {
        const option = new Option(
          device.label || `Camera ${device.deviceId.slice(0, 8)}...`, 
          device.deviceId
        );
        if (selectedDevices.camera && selectedDevices.camera.deviceId === device.deviceId) {
          option.selected = true;
        }
        cameraSelector.appendChild(option);
      });

      // Setup mic selector  
      micSelector.innerHTML = '<option disabled selected>Select microphone...</option>';
      const audioDevices = allDevices.filter(d => d.kind === 'audioinput');
      console.log("üé§ Audio devices found:", audioDevices.length);
      
      audioDevices.forEach(device => {
        const option = new Option(
          device.label || `Microphone ${device.deviceId.slice(0, 8)}...`, 
          device.deviceId
        );
        if (selectedDevices.mic && selectedDevices.mic.deviceId === device.deviceId) {
          option.selected = true;
        }
        micSelector.appendChild(option);
      });

      // Add event listeners
      cameraSelector.addEventListener('change', async (e) => {
        if (e.target.value) {
          console.log("üìπ Changing camera to:", e.target.value);
          try {
            await call.setInputDevicesAsync({ videoDeviceId: e.target.value });
            showToast('üìπ Camera changed');
          } catch (error) {
            console.error("‚ùå Camera change failed:", error);
            showToast('‚ùå Camera change failed');
          }
        }
      });

      micSelector.addEventListener('change', async (e) => {
        if (e.target.value) {
          console.log("üé§ Changing microphone to:", e.target.value);
          try {
            await call.setInputDevicesAsync({ audioDeviceId: e.target.value });
            showToast('üé§ Microphone changed');
          } catch (error) {
            console.error("‚ùå Microphone change failed:", error);
            showToast('‚ùå Microphone change failed');
          }
        }
      });

      console.log("‚úÖ Device selectors set up successfully");

    } catch (error) {
      console.error('‚ùå Error setting up device selectors:', error);
      showToast('‚ùå Device settings unavailable');
    }
  }

  // Audio level monitoring for microphone confirmation
  let audioLevelObserver = null;
  
  function startAudioLevelMonitoring() {
    if (call && !audioLevelObserver) {
      console.log("üé§ Starting audio level monitoring...");
      audioLevelObserver = call.startLocalAudioLevelObserver(100); // Check every 100ms
      
      call.on('local-audio-level', (event) => {
        const level = event.audioLevel;
        console.log("üîä MICROPHONE AUDIO LEVEL:", level);
        
        if (level > 0.01) { // Threshold for detecting sound
          console.log("‚úÖ MICROPHONE IS WORKING! Audio detected:", level);
        }
      });
    }
  }
  
  // Control functions
  function toggleMic() {
    console.log("üé§ Toggling microphone. Current state:", isMicOn);
    
    isMicOn = !isMicOn;
    call.setLocalAudio(isMicOn);
    
    console.log("üé§ NEW MICROPHONE STATE:", isMicOn ? "ON" : "MUTED");
    console.log("üé§ Daily.co localAudio() returns:", call.localAudio());
    
    const micBtn = document.getElementById('mic-btn');
    if (isMicOn) {
      micBtn.classList.remove('active');
      showToast('üé§ Microphone on - Speak to test!');
      console.log("‚úÖ MICROPHONE ENABLED - Check console for audio levels");
      
      // Start monitoring when mic is on
      startAudioLevelMonitoring();
    } else {
      micBtn.classList.add('active');
      showToast('üîá Microphone muted');
      console.log("üîá MICROPHONE DISABLED");
    }
    
    // Log participant state
    const localParticipant = call.participants().local;
    if (localParticipant) {
      console.log("üë§ Local participant audio track state:", localParticipant.tracks.audio);
    }
  }

  function toggleCamera() {
    isCameraOn = !isCameraOn;
    call.setLocalVideo(isCameraOn);
    
    const cameraBtn = document.getElementById('camera-btn');
    const localVideo = document.getElementById('local-video');
    const placeholder = document.getElementById('local-placeholder');
    
    if (isCameraOn) {
      cameraBtn.classList.remove('active');
      localVideo.style.display = 'block';
      placeholder.style.display = 'none';
      showToast('üìπ Camera on');
    } else {
      cameraBtn.classList.add('active');
      localVideo.style.display = 'none';
      placeholder.style.display = 'flex';
      showToast('üì∑ Camera off');
    }
  }

  async function toggleScreenShare() {
    const screenShareBtn = document.getElementById('screen-share-btn');
    
    if (!isScreenSharing) {
      try {
        await call.startScreenShare({
          displayMediaOptions: {
            audio: true,
            video: true,
            selfBrowserSurface: 'exclude',
            surfaceSwitching: 'include'
          }
        });
        isScreenSharing = true;
        screenShareBtn.classList.add('active');
        showToast('üñ•Ô∏è Screen sharing started');
      } catch (error) {
        console.error('Screen share failed:', error);
        showToast('‚ùå Screen share failed');
      }
    } else {
      try {
        await call.stopScreenShare();
        isScreenSharing = false;
        screenShareBtn.classList.remove('active');
        showToast('üñ•Ô∏è Screen sharing stopped');
      } catch (error) {
        console.error('Stop screen share failed:', error);
      }
    }
  }

  function toggleSettings() {
    const settingsPanel = document.getElementById('settings-panel');
    if (settingsPanel.classList.contains('hidden')) {
      settingsPanel.classList.remove('hidden');
    } else {
      settingsPanel.classList.add('hidden');
    }
  }

  function leaveCall() {
    if (call) {
      call.leave();
    }
    window.location.reload();
  }

  // Event listeners for controls
  document.getElementById('mic-btn').addEventListener('click', toggleMic);
  document.getElementById('camera-btn').addEventListener('click', toggleCamera);
  document.getElementById('screen-share-btn').addEventListener('click', toggleScreenShare);
  document.getElementById('settings-btn').addEventListener('click', toggleSettings);
  document.getElementById('leave-btn').addEventListener('click', leaveCall);
  document.getElementById('close-settings').addEventListener('click', toggleSettings);

  // Timer functions
  function startTimer() {
    timerInterval = setInterval(updateTimer, 1000);
  }

  function updateTimer() {
    const minutes = Math.floor(timeRemaining / 60);
    const seconds = timeRemaining % 60;
    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    document.getElementById('timer').textContent = timeString;
    document.getElementById('timer-header').textContent = timeString;
    
    if (timeRemaining > 0) {
      timeRemaining--;
    } else {
      clearInterval(timerInterval);
      showToast('‚è∞ Time\'s up! Thanks for chatting!');
      if (call) call.leave();
    }
  }

  // Sticky timer scroll handler
  window.addEventListener('scroll', function() {
    const stickyTimer = document.getElementById('stickyTimer');
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    
    if (scrollTop > 200 && !document.getElementById('video-interface').classList.contains('hidden')) {
      stickyTimer.style.opacity = '1';
      stickyTimer.style.transform = 'translateY(0)';
    } else {
      stickyTimer.style.opacity = '0';
      stickyTimer.style.transform = 'translateY(-20px)';
    }
  });

  // Toast function
  function showToast(message) {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    toastMessage.textContent = message;
    toast.classList.remove('hidden', 'translate-y-full');
    
    setTimeout(() => {
      toast.classList.add('translate-y-full');
      setTimeout(() => toast.classList.add('hidden'), 300);
    }, 3000);
  }

  // Spark functions
  function navigateSpark(direction) {
    if (direction === 'next') {
      currentSparkIndex = (currentSparkIndex + 1) % currentSparks.length;
    } else {
      currentSparkIndex = currentSparkIndex === 0 ? currentSparks.length - 1 : currentSparkIndex - 1;
    }
    updateSparkDisplay();
    
    // Sync with other participants
    if (call) {
      call.sendAppMessage({
        type: 'spark-navigation',
        sparkIndex: currentSparkIndex
      });
    }
  }

  function updateSparkDisplay() {
    document.getElementById('sparkText').textContent = currentSparks[currentSparkIndex];
    document.getElementById('sparkNumber').textContent = currentSparkIndex + 1;
    
    // Update navigation dots
    for (let i = 1; i <= 3; i++) {
      const dot = document.getElementById(`sparkDot${i}`);
      if (i === currentSparkIndex + 1) {
        dot.className = 'w-2 h-2 bg-main-red rounded-full transition-all';
      } else {
        dot.className = 'w-2 h-2 bg-gray-300 rounded-full transition-all';
      }
    }
    
    // Reset selection state
    const currentSparkEl = document.getElementById('currentSpark');
    currentSparkEl.classList.remove('ring-4', 'ring-gold');
    currentSparkEl.style.background = '';
    sparkIsSelected = false;
  }

  function selectCurrentSpark() {
    const currentSparkEl = document.getElementById('currentSpark');
    
    sparkIsSelected = !sparkIsSelected;
    
    if (sparkIsSelected) {
      currentSparkEl.classList.add('ring-4', 'ring-gold');
      currentSparkEl.style.background = 'linear-gradient(135deg, #FFD166 0%, #FFB6B9 100%)';
      showToast('üåü Spark highlighted for both users!');
    } else {
      currentSparkEl.classList.remove('ring-4', 'ring-gold');
      currentSparkEl.style.background = '';
      showToast('üí´ Spark deselected');
    }
    
    // Sync selection with other participants
    if (call) {
      call.sendAppMessage({
        type: 'spark-selected',
        sparkIndex: currentSparkIndex,
        isSelected: sparkIsSelected
      });
    }
  }

  // Load existing sparks for this room on join
  async function loadExistingSparks() {
    try {
      console.log("üîç Loading existing sparks for room...");
      
      const response = await fetch(`https://chatspheresfirebasepromptsai-default-rtdb.firebaseio.com/sparks.json?orderBy="room_url"&equalTo="${encodeURIComponent(roomUrl)}"&limitToLast=1`);
      
      if (response.ok) {
        const data = await response.json();
        
        if (data && Object.keys(data).length > 0) {
          const latestSparkEntry = Object.values(data)[0];
          
          if (latestSparkEntry.sparks && latestSparkEntry.sparks.length > 0) {
            console.log("‚úÖ Found existing sparks:", latestSparkEntry.sparks);
            currentSparks = latestSparkEntry.sparks;
            currentSparkIndex = 0;
            updateSparkDisplay();
            showToast(`üìö Loaded ${latestSparkEntry.sparks.length} saved sparks for "${latestSparkEntry.topic}"!`);
            return;
          }
        }
      }
      
      console.log("üìù No existing sparks found, using defaults");
    } catch (error) {
      console.error("‚ùå Error loading existing sparks:", error);
      console.log("üìù Using default sparks due to error");
    }
  }

  // Initialize sparks after joining call
  async function initializeSparks() {
    // Load existing sparks first
    await loadExistingSparks();
    
    // If we still have default sparks and have a topic, generate new ones
    const currentTopic = document.getElementById('topic-display').textContent;
    if (currentSparks.length === 3 && currentTopic && currentTopic !== 'Loading Topic...' && currentTopic !== 'General Chat') {
      console.log("ü§ñ Auto-generating sparks for topic:", currentTopic);
      try {
        await generateSparksWithAI(currentTopic);
      } catch (error) {
        console.log("üìù Auto-generation failed, keeping defaults:", error.message);
      }
    }
  }

  // AI Spark Generation Functions
  async function generateNewSparks() {
    const generateBtn = document.getElementById('newSparkBtn');
    const originalText = generateBtn.innerHTML;
    
    try {
      // Show loading state
      generateBtn.innerHTML = 'üîÑ generating...';
      generateBtn.disabled = true;
      
      // Get current topic
      const currentTopic = document.getElementById('topic-display').textContent || 'general conversation';
      console.log("üß† Generating sparks for topic:", currentTopic);
      
      await generateSparksWithAI(currentTopic);
      
    } catch (error) {
      console.error("‚ùå Spark generation failed:", error);
      showToast('‚ùå Failed to generate sparks: ' + error.message);
    } finally {
      // Reset button
      generateBtn.innerHTML = originalText;
      generateBtn.disabled = false;
    }
  }

  async function generateCustomSparks() {
    const customTopic = document.getElementById('userPrompt').value.trim();
    const generateBtn = document.querySelector('button[onclick="generateCustomSparks()"]');
    const originalText = generateBtn.innerHTML;
    
    if (!customTopic) {
      showToast('üí≠ Please enter a topic first!');
      document.getElementById('userPrompt').focus();
      return;
    }
    
    try {
      // Show loading state
      generateBtn.innerHTML = '‚ö° generating...';
      generateBtn.disabled = true;
      
      console.log("üß† Generating custom sparks for:", customTopic);
      
      await generateSparksWithAI(customTopic);
      
      // Clear input after successful generation
      document.getElementById('userPrompt').value = '';
      
    } catch (error) {
      console.error("‚ùå Custom spark generation failed:", error);
      showToast('‚ùå Failed to generate custom sparks: ' + error.message);
    } finally {
      // Reset button
      generateBtn.innerHTML = originalText;
      generateBtn.disabled = false;
    }
  }

  async function generateSparksWithAI(topic) {
    const sparkPrompt = `Give 5 fresh and creative conversation starters about "${topic}". Number each one clearly (1. 2. 3. 4. 5.) and make them engaging and thought-provoking.`;

    console.log("ü§ñ Calling Netlify Function for AI sparks...");
    
    // Step 1: Call Netlify Function to generate sparks (secure API key)
    const response = await fetch("/.netlify/functions/generateSpark", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json" 
      },
      body: JSON.stringify({ 
        prompt: sparkPrompt 
      })
    });

    if (!response.ok) {
      // Enhanced error handling for 401 and other common errors
      let errorMessage = `Netlify Function error: ${response.status} ${response.statusText}`;
      
      if (response.status === 401) {
        errorMessage = "‚ùå API Authentication failed. Please check your OpenAI API key configuration in Netlify.";
        console.error("üîë 401 Error - API key issue:", {
          status: response.status,
          statusText: response.statusText,
          url: response.url
        });
      } else if (response.status === 404) {
        errorMessage = "‚ùå Netlify Function not found. Make sure your generateSpark function is deployed.";
      } else if (response.status >= 500) {
        errorMessage = "‚ùå Server error. Please try again in a moment.";
      }
      
      throw new Error(errorMessage);
    }

    const json = await response.json();
    const rawContent = json.result || "";
    
    console.log("ü§ñ Netlify Function raw response:", rawContent);
    
    // Parse the numbered responses
    const sparks = rawContent
      .split("\n")
      .map(line => line.trim())
      .filter(line => line.length > 0 && /^\d+\./.test(line))
      .map(line => line.replace(/^\d+\.\s*/, '').trim()) // Remove number prefix
      .filter(line => line.length > 10); // Filter out too short responses

    console.log("‚ú® Parsed sparks:", sparks);

    if (sparks.length === 0) {
      throw new Error("No valid sparks generated from AI response");
    }

    // Step 2: Save to Firebase
    console.log("üíæ Saving sparks to Firebase...");
    
    const sparkData = {
      topic: topic,
      sparks: sparks,
      room_url: roomUrl,
      created_at: new Date().toISOString(),
      generated_by: "ai"
    };

    const saveResponse = await fetch(`https://chatspheresfirebasepromptsai-default-rtdb.firebaseio.com/sparks.json`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(sparkData)
    });

    if (!saveResponse.ok) {
      throw new Error("Failed to save sparks to Firebase");
    }

    // Step 3: Update UI immediately
    console.log("üé® Updating UI with new sparks...");
    
    currentSparks = sparks;
    currentSparkIndex = 0;
    updateSparkDisplay();
    
    // Sync with other participant
    if (call) {
      call.sendAppMessage({
        type: 'sparks-updated',
        sparks: sparks,
        topic: topic
      });
    }

    showToast(`‚úÖ Generated ${sparks.length} sparks for "${topic}"!`);
    console.log("‚úÖ Spark generation complete!");
  }

  // Initialize
  console.log("ChatSpheres Video Chat Room Loading... üåü");
</script>

</body>
</html>
